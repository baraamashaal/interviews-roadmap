# 11.4 How do suspense and async setup work in Vue 3?

## Quick Revision
- `Suspense` waits for async dependencies (async setup, async components) before rendering, showing fallback content meanwhile.
- `setup()` can be `async` or return a promise; Vue suspends rendering until it resolves.
- Use Suspense for data fetching, lazy loading, and coordinating multiple async tasks with error handling.

## Detailed Explanation
### Async setup()
When `setup()` is marked `async` or returns a promise, Vue treats the component as async. It waits for the promise to resolve, providing resolved data to the template. During SSR, async setup ensures data is ready before rendering HTML.

### Suspense Component
Wrap async components in `<Suspense>`. The default slot renders once all async dependencies resolve; the fallback slot renders while pending. Use the `onResolve` and `onFallback` events to react to state changes. Suspense works with nested async components.

### Error Handling
If async setup throws, the error propagates to error boundaries (`onErrorCaptured`). Combine Suspense with `<template #error>` via libraries or custom wrappers to show error UI. Avoid long-running async operations blocking UI; use timeouts or streaming for better UX.

## Code Example
```vue
<template>
  <Suspense>
    <template #default>
      <AsyncProfile />
    </template>
    <template #fallback>
      <p>Loading profile…</p>
    </template>
  </Suspense>
</template>
```
```vue
<script setup>
import { ref } from 'vue';

const profile = ref(null);

const data = await fetch('/api/profile').then((res) => res.json());
profile.value = data;
</script>
```

## Resources
- [Vue.js Docs – Suspense](https://vuejs.org/guide/built-ins/suspense.html) – usage patterns and limitations.
- [Vue.js Docs – Async setup](https://vuejs.org/guide/components/async.html#async-setup) – explains async setup semantics.
- [Vue SSR Guide – Suspense](https://vuejs.org/guide/scaling-up/ssr.html#suspense) – SSR considerations for async components.
